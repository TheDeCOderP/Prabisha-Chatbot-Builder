// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider     = "prisma-client"
  output       = "../generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "mysql"
}

enum Role {
  ADMIN
  USER
}

model Account {
  id                       String   @id @default(cuid())
  userId                   String
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String?  @db.Text
  access_token             String?  @db.Text
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String?  @db.Text
  session_state            String?
  refresh_token_expires_in Int?
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt
  user                     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  image         String?
  password      String?
  emailVerified DateTime?

  role Role @default(USER)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  resetToken       String? // Optional, stores token
  resetTokenExpiry DateTime? // Expiry timestamp

  accounts        Account[]
  sessions        Session[]
  workspaces      WorkspaceMember[]
}

model Workspace {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())

  members  WorkspaceMember[]
  chatbots Chatbot[]
}

model WorkspaceMember {
  id   String        @id @default(cuid())
  role WorkspaceRole @default(MEMBER)

  userId      String
  workspaceId String

  user      User      @relation(fields: [userId], references: [id])
  workspace Workspace @relation(fields: [workspaceId], references: [id])

  @@unique([userId, workspaceId])
}

enum WorkspaceRole {
  OWNER
  ADMIN
  MEMBER
}

enum ShapeType {
  ROUND
  SQUARE
  ROUNDED_SQUARE
}

enum BorderType {
  FLAT
  ROUND
  ROUNDED_FLAT
}

model Chatbot {
  id           String  @id @default(cuid())
  name         String
  description  String?
  suggestions  Json?

  theme        String?

  icon         String?
  iconSize     Int?
  iconColor    String?
  iconShape    ShapeType @default(ROUND)
  iconBorder   BorderType @default(FLAT)
  iconBgColor  String?

  avatar       String?
  avatarSize   Int?
  avatarColor  String?
  avatarBorder BorderType @default(FLAT)
  avatarBgColor String?

  popup_onload Boolean @default(false)

  greeting     String  @default("Hi there! How can I help you today?")
  directive    String  @db.LongText 
  
  model       String @default("meta-llama/Llama-3.3-70B-Instruct-Turbo")
  max_tokens  Int    @default(500)
  temperature Float  @default(0.7)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  form          LeadForm? 
  leads         Lead[]
  flows         Flow[]
  conversations Conversation[]
  knowledgeBases KnowledgeBase[]
  logics        Logic[] // Add this line

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id])

  @@index([workspaceId])
}

enum LeadTiming {
  BEGINNING
  MIDDLE
  END
}

enum LeadFormStyle {
  EMBEDDED
  MESSAGES
}

model LeadForm {
  id            String   @id @default(cuid())
  title         String   @default("Get started")
  description   String?

  fields        Json
  leadTiming    LeadTiming @default(BEGINNING)
  leadFormStyle LeadFormStyle @default(EMBEDDED)

  chatbotId String  @unique
  chatbot   Chatbot @relation(fields: [chatbotId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  leads         Lead[]

  @@index([chatbotId])
}

model Lead {
  id           String   @id @default(cuid())
  
  data        Json

  formId      String
  form        LeadForm @relation(fields: [formId], references: [id])

  chatbotId String
  chatbot   Chatbot @relation(fields: [chatbotId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum SenderType {
  USER
  BOT
}

// Add Conversation model
model Conversation {
  id        String    @id @default(cuid())
  title     String?   // Optional title (could be first message or generated)
  chatbotId String
  userId    String?   // Optional user ID for user tracking
  
  // Status fields
  isActive  Boolean   @default(true)
  
  // Metadata
  metadata  Json?     // Additional metadata like browser info, location, etc.
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  endedAt   DateTime? // When conversation was ended/archived
  
  // Relations
  chatbot    Chatbot  @relation(fields: [chatbotId], references: [id])
  messages   Message[] // Messages belong to a conversation
  
  @@index([chatbotId])
  @@index([userId])
  @@index([isActive])
  @@index([createdAt])
}

model Message {
  id             String     @id @default(cuid())
  content        String     @db.LongText
  senderType     SenderType
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  conversationId  String 
  conversation    Conversation @relation(fields: [conversationId], references: [id]) // Add this relation

  @@index([conversationId])
  @@index([createdAt])
  @@index([senderType])
}

enum FlowType {
  INTEND
  PRODUCT
  PAGE
  FAQ
  SUPPORT
  CUSTOM
}

model Flow {
  id        String   @id @default(cuid())
  name      String
  type      FlowType
  createdAt DateTime @default(now())

  chatbotId String
  chatbot   Chatbot @relation(fields: [chatbotId], references: [id])
  nodes     Node[]
  edges     Edge[]
}

model Node {
  id     String @id @default(cuid())
  flowId String

  type      NodeType
  name      String
  config    Json // node-specific config
  positionX Float
  positionY Float

  createdAt DateTime @default(now())

  flow Flow @relation(fields: [flowId], references: [id])

  outgoing Edge[] @relation("OutgoingEdges")
  incoming Edge[] @relation("IncomingEdges")

  @@index([flowId])
}

model Edge {
  id     String @id @default(cuid())
  flowId String

  sourceId String
  targetId String

  condition Json?

  flow Flow @relation(fields: [flowId], references: [id])

  source Node @relation("OutgoingEdges", fields: [sourceId], references: [id])
  target Node @relation("IncomingEdges", fields: [targetId], references: [id])

  @@index([flowId])
}

enum NodeType {
  TRIGGER
  LLM
  TOOL
  CONDITION
  MEMORY
  OUTPUT
}

model KnowledgeBase {
  id        String   @id @default(cuid())
  chatbotId String
  name      String
  type      KBType // PRODUCT, PAGE, FAQ, DOC
  indexName String // vector index name
  createdAt DateTime @default(now())

  chatbot   Chatbot    @relation(fields: [chatbotId], references: [id])
  documents Document[]
}

model Document {
  id              String   @id @default(cuid())
  knowledgeBaseId String
  source          String // url, pdf, product_id
  content         String   @db.LongText
  metadata        Json
  createdAt       DateTime @default(now())

  knowledgeBase KnowledgeBase @relation(fields: [knowledgeBaseId], references: [id])
}

enum KBType {
  PRODUCT
  PAGE
  FAQ
  DOC
}

// Logic Model - Main table for all logic features
model Logic {
  id        String   @id @default(cuid())
  chatbotId String
  type      LogicType
  
  // Basic info
  name      String
  description String?
  
  // Configuration data (can store partial config here)
  config    Json     // Store common configuration as JSON
  
  // Activation rules
  triggerType    TriggerType @default(KEYWORD)
  keywords       String?     @db.Text // JSON array of keywords
  showAlways     Boolean     @default(false)
  showAtEnd      Boolean     @default(false)
  showOnButton   Boolean     @default(false)
  triggerConfig  Json?       // Additional trigger configuration
  
  // Status
  isActive       Boolean     @default(true)
  position       Int?        // For ordering/priority
  
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  
  // Relations
  chatbot        Chatbot     @relation(fields: [chatbotId], references: [id])
  linkButton     LinkButton? // Optional one-to-one for link button logic
  meetingSchedule MeetingSchedule? // Optional one-to-one for meeting logic
  leadCollection LeadCollection? // Optional one-to-one for lead collection
  
  @@index([chatbotId])
  @@index([type])
  @@index([isActive])
  @@index([position])
}

// Link Button Logic - Specific configuration for link buttons
model LinkButton {
  id        String   @id @default(cuid())
  logicId   String   @unique
  
  buttonText    String
  buttonIcon    String?    // Icon name (e.g., "Calendar", "Link", etc.)
  buttonLink    String
  openInNewTab  Boolean    @default(true)
  
  // Styling options
  buttonColor   String?    @default("#3b82f6")
  textColor     String?    @default("#ffffff")
  buttonSize    ButtonSize @default(MEDIUM)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  logic Logic @relation(fields: [logicId], references: [id])
}

// Meeting Schedule Logic - Specific configuration for meeting scheduling
model MeetingSchedule {
  id           String   @id @default(cuid())
  logicId      String   @unique
  
  calendarType CalendarType @default(CALENDLY)
  calendarLink String
  calendarId   String?  // For Google/Outlook calendar integration
  
  // Meeting options
  duration     Int?     @default(30) // minutes
  timezone     String?  @default("UTC")
  titleFormat  String?  @default("Meeting with {company}")
  description  String?  @db.Text
  
  // Availability settings
  availabilityDays  String? @db.Text // JSON array of days [0-6]
  availabilityHours String? @db.Text // JSON object with start/end times
  bufferTime        Int?    @default(5) // minutes
  
  // Display options
  showTimezoneSelector Boolean @default(true)
  requireConfirmation  Boolean @default(false)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  logic Logic @relation(fields: [logicId], references: [id])
}

// Lead Collection Logic - Specific configuration for lead forms
model LeadCollection {
  id           String   @id @default(cuid())
  logicId      String   @unique
  
  formTitle    String   @default("Get Started")
  formDesc     String?  @db.Text
  
  leadTiming    LeadTiming @default(BEGINNING)
  leadFormStyle LeadFormStyle @default(EMBEDDED)
  cadence       Cadence @default(ALL_AT_ONCE)
  
  fields       String   @db.Text // JSON array of form fields
  fieldOrder   String?  @db.Text // JSON array of field IDs for ordering
  
  // Success/Completion options
  successMessage String? @db.Text
  redirectUrl    String?
  autoClose      Boolean @default(true)
  showThankYou   Boolean @default(true)
  
  // Notification options
  notifyEmail    String?
  webhookUrl     String?
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  logic Logic @relation(fields: [logicId], references: [id])
  formFields FormField[] // Add this reverse relationship
}

// Form Field Definition (optional - can also store in JSON)
model FormField {
  id              String   @id @default(cuid())
  leadCollectionId String
  
  type            FieldType
  label           String
  required        Boolean  @default(true)
  placeholder     String?
  defaultValue    String?
  validationRules String?  @db.Text // JSON validation rules
  
  // For select/radio/checkbox fields
  options         String?  @db.Text // JSON array of options
  
  order           Int      @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  leadCollection LeadCollection @relation(fields: [leadCollectionId], references: [id])
  
  @@index([leadCollectionId])
  @@index([order])
}

enum LogicType {
  COLLECT_LEADS
  LINK_BUTTON
  SCHEDULE_MEETING
  ZAPIER_INTEGRATION   // For future features
  SUGGESTIONS          // For future features
  CUSTOM_ACTION        // For future features
}

enum TriggerType {
  KEYWORD
  ALWAYS
  MANUAL
  END_OF_CONVERSATION
  MESSAGE_COUNT        // Trigger after X messages
  TIME_DELAY           // Trigger after X seconds/minutes
}

enum ButtonSize {
  SMALL
  MEDIUM
  LARGE
}

enum CalendarType {
  CALENDLY
  GOOGLE_CALENDAR
  OUTLOOK_CALENDAR
  CUSTOM
}

enum Cadence {
  ALL_AT_ONCE
  ONE_BY_ONE
  GROUPED
}

enum FieldType {
  TEXT
  EMAIL
  PHONE
  NUMBER
  CURRENCY
  DATE
  LINK
  SELECT
  RADIO
  CHECKBOX
  TEXTAREA
  MULTISELECT
}